# DataAgent 工程优化需求 001

## 需求概述

对 DataAgent 的 SQL 生成和语义一致性检查模块进行深度优化，提升系统稳定性和准确性。本次优化主要针对提示词工程、重试机制、错误分类统计等方面进行改进。

## 优化目标

1. 提升 SQL 生成准确率至 90% 以上
2. 减少无效重试次数，提高系统响应速度
3. 增强语义一致性检查的精准度
4. 优化系统资源使用效率

## 详细需求说明

### 1. SqlGenerateDispatcher.java 计数器优化

#### 功能要求
在现有重试机制基础上，增加细粒度的错误分类统计和阈值控制。

#### 具体实现

```java
// 新增计数器变量
private int sqlSyntaxErrorCount = 0;
private int sqlSemanticErrorCount = 0;
private int sqlExecutionErrorCount = 0;

// 新增阈值配置
private static final int SQL_SYNTAX_ERROR_MAX_RETRY = 10;
private static final int SQL_SEMANTIC_ERROR_MAX_RETRY = 10;
private static final int SQL_EXECUTION_ERROR_MAX_RETRY = 10;
private static final double SQL_SEMANTIC_PASS_THRESHOLD = 0.8;
```

#### 控制逻辑

- 语法错误：最多重试 10 次（通常为 LLM 格式问题，多次重试意义不大）
- 语义错误：最多重试 10 次（需要更多轮次理解业务规则）
- 执行错误：最多重试 10 次（如字段不存在、语法冲突等）
- 语义通过阈值：0.8（达到此阈值认为语义基本正确）

### 2. new-sql-generate.txt 提示词优化

#### 2.1 增加思维链指导

```
# 分析步骤（请在心里默念，不要输出）
1. 从【当前执行步骤】中提取核心需求：[表名、字段、聚合方式]
2. 从【全局任务背景】中提取显式约束：[时间范围、状态值、其他条件]
3. 从【业务知识】中提取隐式规则：[销售额定义、特殊计算规则]
4. 检查【数据库 Schema】确认所有字段存在
5. 生成 SQL，确保包含第 1-3 步提取的所有约束
```

#### 2.2 背景信息使用规则优化

将第 15-16 行修改为：
```
【全局任务背景】和【业务知识】必须与【当前执行步骤】联合使用：
- 如果【当前执行步骤】中未明确时间范围，但【全局任务背景】中有'2025年'，则 SQL 必须包含该约束
- 如果【业务知识】中定义了'销售额=已完成订单'，则 SQL 必须包含过滤条件
- 优先级：当前步骤指令 > 全局任务背景 > 业务知识
```

#### 2.3 增加重试指导部分

```
# 重试修复指导（仅在重试时使用）
{if has retry context}
上一次 SQL 未通过语义一致性检查，具体缺陷如下：
- 缺少时间过滤：{expected_time_filter}
- 缺少状态过滤：{expected_status_filter}
- 幻觉字段：{hallucinated_fields}

请在生成新 SQL 时确保补全以上条件。
{endif}
```

#### 2.4 增加 Few-Shot 示例

添加 2-3 个成功案例作为参考模板。

### 3. planner.txt 优化

#### 当前问题

第 36-42 行描述不够详细。

#### 优化方案

```
**必须**包含：
- 目标表名（从 schema 中选择存在的表）
- 具体的聚合维度（如按月、按地区分组）
- **完整的过滤条件**：
  * 从用户问题中提取显式条件（如 '2025年' → WHERE ORDER_DATE >= '2025-01-01' AND ORDER_DATE <= '2025-12-31'）
  * 从 evidence 中提取隐式业务规则（如'销售额'通常指已完成订单 → WHERE STATUS = 'completed'）
  * 从 semantic_model 中提取字段映射（如'销售额' → TOTAL_AMOUNT 字段）
```

### 4. EvidenceRecallNode.java 优化

#### 优化方向
增加 top_k 参数或改进召回策略，提高证据召回的相关性和准确性。

### 5. SqlGenerateNode.java 重试优化

#### 当前位置
第 95-106 行

#### 优化建议
让 LLM 返回结构化的错误信息，便于系统理解和处理。

### 6. semantic-consistency.txt 输出格式优化

#### 当前格式
```
2、不通过。[具体原因]
```

#### 优化后格式
```json
{
  "is_passed": false,
  "missing_conditions": [
    {
      "type": "time_filter",
      "expected": "WHERE ORDER_DATE >= '2025-01-01' AND ORDER_DATE <= '2025-12-31'",
      "reason": "用户问题中明确提到'2025年'"
    },
    {
      "type": "status_filter",
      "expected": "WHERE STATUS = 'completed'",
      "reason": "业务知识定义销售额为已完成订单"
    }
  ],
  "hallucinated_fields": [],
  "syntax_errors": []
}
```

### 7. PromptHelper.java Schema 信息优化

#### 当前问题
第 88-120 行构建的 Schema 信息过于庞大，影响性能。

#### 优化方案
- **智能过滤**：只包含与当前步骤相关的表和列
- **分阶段加载**：先加载表结构，需要时再加载列详情
- **Schema 压缩**：
  - 只保留列名和类型，去掉描述
  - 去掉外键信息（除非涉及 JOIN）
  - 去掉示例数据

### 8. Nl2SqlServiceImpl.java LLM 参数优化

#### 当前问题
第 58-95 行使用默认参数调用 LLM。

#### 优化方案
```java
// 降低温度参数
// 首次生成：temperature=0.1（更稳定）
// 重试时：temperature=0.3（增加多样性）
// 最后几次：temperature=0.5（尝试不同思路）
```

### 9. sql-error-fixer.txt 历史信息增强

#### 当前不足

缺乏历史失败记录和成功案例参考。

#### 优化方案

```
## 6. 历史失败记录（如果有）
第1次尝试：[SQL语句] -> [失败原因]
第2次尝试：[SQL语句] -> [失败原因]
...

## 7. 参考成功案例
类似问题的正确SQL：[示例]
```
