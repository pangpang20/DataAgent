server:
  port: 8065
  address: 0.0.0.0

# 存储 DataAgent 业务数据的数据库，并非Agent分析数据的来源
spring:
  main:
    allow-bean-definition-overriding: true
  autoconfigure:
    exclude: ${VECTOR_STORE_EXCLUDE:org.springframework.ai.vectorstore.milvus.autoconfigure.MilvusVectorStoreAutoConfiguration,org.springframework.ai.vectorstore.elasticsearch.autoconfigure.ElasticsearchVectorStoreAutoConfiguration}
  datasource:
    # 数据库类型标识：mysql | dameng
    platform: ${DATASOURCE_PLATFORM:mysql}
    url: ${DATA_AGENT_DATASOURCE_URL:jdbc:mysql://127.0.0.1:3306/data_agent?useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&transformedBitIsBoolean=true&allowMultiQueries=true&allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Shanghai}
    username: ${DATA_AGENT_DATASOURCE_USERNAME:cyl}
    password: ${DATA_AGENT_DATASOURCE_PASSWORD:Audaque@123}
    driver-class-name: ${DATASOURCE_DRIVER_CLASS:com.mysql.cj.jdbc.Driver}
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # 连接池基础配置
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
      # 验证查询，达梦推荐使用 SELECT 1 FROM DUAL，MySQL 使用 SELECT 1
      validation-query: ${DRUID_VALIDATION_QUERY:SELECT 1}
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      # 事务隔离级别：2 (READ_COMMITTED) 是达梦推荐值
      default-transaction-isolation: ${DRUID_TRANSACTION_ISOLATION:2}
  sql:
    init:
      mode: always
      schema-locations:
        - classpath:sql/${spring.datasource.platform}/schema.sql
        - classpath:sql/${spring.datasource.platform}/product_schema.sql
      data-locations:
        - classpath:sql/${spring.datasource.platform}/data.sql
        - classpath:sql/${spring.datasource.platform}/product_data.sql
      continue-on-error: true
      separator: ;
      encoding: utf-8
  ai:
    # LLM API 调用重试配置（针对 429、500、503、504 等错误）
    retry:
      max-attempts: 5                # 最大重试次数（包括首次调用）
      initial-interval: 2000         # 初始重试间隔（毫秒）
      multiplier: 2.0                # 指数退避倍数（每次重试间隔为上次的 multiplier 倍）
    vectorstore:
      milvus:
        enabled: false
        initialize-schema: true
        embedding-dimension: 1024          # 标准配置，用于创建 Milvus 集合
        client:
          host: ${MILVUS_HOST:localhost}
          port: ${MILVUS_PORT:19530}
          username: ${MILVUS_USERNAME:root}
          password: ${MILVUS_PASSWORD:Milvus}
          database-name: ${MILVUS_DATABASE:default}
        collection-name: ${MILVUS_COLLECTION:data_agent_vector}
        flush-delay-ms: 10000  # Milvus flush 操作延迟（毫秒），避免速率限制
        flush-retry-count: 3  # flush 操作重试次数
        flush-initial-backoff-ms: 1000  # flush 操作初始退避时间（毫秒）
        flush-auto: false  # 是否启用自动 flush 功能，默认关闭。关闭时数据插入后不会立即可搜索，需要等待 Milvus 自动 flush 或手动调用 flush
      elasticsearch:
        enabled: false
    alibaba:
      data-agent:
        # Prompt模板配置
        prompt:
          # 外部Prompt目录路径（可选）
          # 配置后优先从外部目录加载Prompt模板，未配置则使用JAR内部资源
          # 支持绝对路径：/opt/dataagent/prompts 或 C:\dataagent\prompts
          # 支持相对路径：./prompts 或 prompts（相对于应用启动目录）
          external-dir: ${DATAAGENT_PROMPT_DIR:}
        vector-store:
          # 向量库类型：simple (内存), milvus
          type: ${VECTOR_STORE_TYPE:simple}
          table-topk-limit: 10
          table-similarity-threshold: 0.2
          default-topk-limit: 8
          default-similarity-threshold: 0.4
        llm-service-type: stream
        code-executor:
          # 运行Python代码的环境（Docker模式需要Docker-in-Docker，Docker容器内不推荐）
          code-pool-executor: local
          # Python执行的最大重试次数
          python-max-tries-count: 5
          
          # Local 执行器配置
          local:
            # 输出读取超时时间（毫秒）
            # 用于等待Python进程stdout/stderr输出完成的时间
            output-read-timeout-ms: 2000
        file:
          type: local
          path-prefix: data-agent
          # 当前目录下不要用点， ./uploads win下拼接完整格式路径会解析不了，比如 data-agent/./uploads win识别不了
          path: uploads
          url-prefix: /uploads
          imageSize: 2097152
          oss:
            access-key-id: ${OSS_ACCESS_KEY_ID:}
            access-key-secret: ${OSS_ACCESS_KEY_SECRET:}
            endpoint: ${OSS_ENDPOINT:}
            bucket-name: ${OSS_BUCKET_NAME:}
            custom-domain: ${OSS_CUSTOM_DOMAIN:}
        max-sql-retry-count: 20  # SQL生成最大重试次数，超过此次数将停止重试并显示"SQL次数生成超限"，未知错误类型时的总重试次数上限
                
        # Fine-grained retry thresholds for different SQL error types
        # Different error types require different retry strategies for optimal performance
        max-sql-syntax-error-retry: 10      # Syntax errors: typically LLM output format issues (e.g., markdown parsing failures)
        max-sql-semantic-error-retry: 10    # Semantic errors: business logic misunderstandings (e.g., missing time filters)
        max-sql-execution-error-retry: 10   # Execution errors: SQL runtime issues (e.g., non-existent fields, type conflicts)
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB
      enabled: true

mybatis:

  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

# Actuator 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
      base-path: /actuator
  endpoint:
    health:
      show-details: always
  health:
    elasticsearch:
      enabled: false  # 禁用 Elasticsearch 健康检查
    defaults:
      enabled: true

logging:
  level:
    com.audaque.cloud.ai.dataagent.service: debug
    com.audaque.cloud.ai.dataagent.service.graph: debug  # 流式输出处理详细日志
    com.audaque.cloud.ai.dataagent.service.nl2sql: debug  # NL2SQL 服务详细日志
    com.audaque.cloud.ai.dataagent.prompt: debug  # Prompt 构建详细日志
    com.audaque.cloud.ai.dataagent.workflow.node: debug  # 工作流节点详细日志（SqlExecuteNode、SemanticConsistencyNode等）
    com.audaque.cloud.ai.dataagent.util: debug  # 工具类详细日志（MarkdownParserUtil等）
    com.audaque.cloud.ai.dataagent.workflow.dispatcher: debug  # 调度器详细日志
    com.alibaba.cloud.ai.mapper: debug
    org.springframework.jdbc: debug
    # 屏蔽 Tomcat HTTP 处理器的 EOFException 日志(客户端正常关闭连接时产生)
    org.apache.coyote.http11.Http11Processor: INFO
    # 屏蔽 favicon.ico 请求的 NoResourceFoundException 错误
    org.springframework.web.servlet.resource.ResourceHttpRequestHandler: ERROR
    # 打印 Agent 相关的 SQL 语句(包括插入、更新操作)
    com.audaque.cloud.ai.dataagent.mapper.AgentMapper: debug
    # 打印 AgentPresetQuestion 相关的 SQL 语句(排查排序问题)
    com.audaque.cloud.ai.dataagent.mapper.AgentPresetQuestionMapper: debug
