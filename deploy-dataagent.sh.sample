#!/bin/bash

################################################################################
# DataAgent 一键部署脚本
################################################################################
# 功能：
# 1. 自动检查并安装所需环境（Java 17、Nginx、Node.js、Yarn）
# 2. 编译打包前后端
# 3. 备份旧版本
# 4. 部署新版本
# 5. 启动服务
# 6. 验证服务状态
################################################################################

set -e  # 遇到错误立即退出

# ============================================================================
# 配置变量（请根据实际环境修改）
# ============================================================================
# 源码目录（脚本所在目录的父目录）
SOURCE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 部署目录
DEPLOY_DIR="/opt/dataagent"

# 服务端口
BACKEND_PORT=8065
FRONTEND_PORT=80

# 数据库配置（首次部署需要手动初始化）
DB_HOST="127.0.0.1"
DB_PORT="3306"
DB_NAME="data_agent"
DB_USER="cyl"
DB_PASSWORD="Audaque@123"

# ============================================================================
# 颜色输出
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# ============================================================================
# 检测操作系统
# ============================================================================
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_VERSION=$VERSION_ID
    else
        error "无法检测操作系统类型"
    fi
    info "检测到操作系统: $OS $OS_VERSION"
}

# ============================================================================
# 检查并安装 Java 17
# ============================================================================
check_install_java() {
    info "检查 Java 环境..."
    
    if command -v java &> /dev/null; then
        JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1)
        if [ "$JAVA_VERSION" -ge 17 ]; then
            info "Java 已安装: $(java -version 2>&1 | head -n1)"
            return 0
        else
            warn "Java 版本过低 (需要 17+)，将安装 Java 17"
        fi
    else
        warn "Java 未安装，将自动安装 Java 17"
    fi
    
    # 安装 Java 17
    case $OS in
        ubuntu|debian)
            info "使用 apt 安装 OpenJDK 17..."
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
            ;;
        centos|rhel|kylin)
            info "使用 yum 安装 OpenJDK 17..."
            sudo yum install -y java-17-openjdk java-17-openjdk-devel
            ;;
        *)
            error "不支持的操作系统: $OS，请手动安装 Java 17"
            ;;
    esac
    
    # 设置 JAVA_HOME
    JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
    export JAVA_HOME
    export PATH=$JAVA_HOME/bin:$PATH
    
    info "Java 安装完成: $(java -version 2>&1 | head -n1)"
}

# ============================================================================
# 检查并安装 Node.js 和 Yarn
# ============================================================================
check_install_nodejs() {
    info "检查 Node.js 环境..."
    
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
        if [ "$NODE_VERSION" -ge 16 ]; then
            info "Node.js 已安装: $(node -v)"
        else
            warn "Node.js 版本过低，将升级到 LTS 版本"
            install_nodejs
        fi
    else
        warn "Node.js 未安装，将自动安装"
        install_nodejs
    fi
    
    # 检查 Yarn
    if ! command -v yarn &> /dev/null; then
        info "安装 Yarn..."
        npm install -g yarn
    fi
    info "Yarn 版本: $(yarn -v)"
}

install_nodejs() {
    case $OS in
        ubuntu|debian)
            info "使用 NodeSource 仓库安装 Node.js 18 LTS..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            ;;
        centos|rhel|kylin)
            info "使用 NodeSource 仓库安装 Node.js 18 LTS..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs
            ;;
        *)
            error "不支持的操作系统: $OS，请手动安装 Node.js 16+"
            ;;
    esac
}

# ============================================================================
# 检查并安装 Nginx
# ============================================================================
check_install_nginx() {
    info "检查 Nginx..."
    
    if command -v nginx &> /dev/null; then
        info "Nginx 已安装: $(nginx -v 2>&1)"
        return 0
    fi
    
    warn "Nginx 未安装，将自动安装"
    
    case $OS in
        ubuntu|debian)
            info "使用 apt 安装 Nginx..."
            sudo apt-get update
            sudo apt-get install -y nginx
            ;;
        centos|rhel|kylin)
            info "使用 yum 安装 Nginx..."
            sudo yum install -y nginx
            ;;
        *)
            error "不支持的操作系统: $OS，请手动安装 Nginx"
            ;;
    esac
    
    # 启动 Nginx
    sudo systemctl enable nginx
    sudo systemctl start nginx
    
    info "Nginx 安装完成: $(nginx -v 2>&1)"
}

# ============================================================================
# 检查 MySQL
# ============================================================================
check_mysql() {
    info "检查 MySQL 连接..."
    
    if ! command -v mysql &> /dev/null; then
        warn "MySQL 客户端未安装，跳过数据库连接测试"
        warn "请确保 MySQL 服务已启动并已执行数据库初始化脚本"
        return 0
    fi
    
    # 测试数据库连接
    if mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASSWORD -e "USE $DB_NAME;" 2>/dev/null; then
        info "数据库连接正常"
    else
        warn "数据库连接失败或数据库不存在"
        warn "首次部署请手动执行数据库初始化："
        warn "  mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASSWORD < $SOURCE_DIR/data-agent-management/src/main/resources/sql/schema.sql"
    fi
}

# ============================================================================
# 停止服务
# ============================================================================
stop_services() {
    info "停止现有服务..."
    
    # 停止后端服务
    if lsof -i:$BACKEND_PORT > /dev/null 2>&1; then
        BACKEND_PID=$(lsof -t -i:$BACKEND_PORT)
        info "停止后端服务 (PID: $BACKEND_PID)..."
        kill -15 $BACKEND_PID 2>/dev/null || true
        sleep 3
        
        # 强制停止
        if lsof -i:$BACKEND_PORT > /dev/null 2>&1; then
            warn "强制停止后端服务..."
            kill -9 $BACKEND_PID 2>/dev/null || true
            sleep 1
        fi
        info "后端服务已停止"
    else
        info "后端服务未运行"
    fi
}

# ============================================================================
# 备份旧版本
# ============================================================================
backup_old_version() {
    info "备份旧版本..."
    
    BACKUP_DIR="$DEPLOY_DIR/backup/$(date +%Y%m%d_%H%M%S)"
    
    if [ -d "$DEPLOY_DIR" ] && [ -f "$DEPLOY_DIR/dataagent-backend.jar" ]; then
        mkdir -p "$BACKUP_DIR"
        
        # 备份后端 JAR
        if [ -f "$DEPLOY_DIR/dataagent-backend.jar" ]; then
            cp "$DEPLOY_DIR/dataagent-backend.jar" "$BACKUP_DIR/"
            info "已备份后端 JAR 到: $BACKUP_DIR/dataagent-backend.jar"
        fi
        
        # 备份前端文件
        if [ -d "/var/www/dataagent" ]; then
            sudo cp -r /var/www/dataagent "$BACKUP_DIR/frontend"
            info "已备份前端文件到: $BACKUP_DIR/frontend"
        fi
        
        # 备份配置文件
        if [ -f "$DEPLOY_DIR/application.yml" ]; then
            cp "$DEPLOY_DIR/application.yml" "$BACKUP_DIR/"
            info "已备份配置文件到: $BACKUP_DIR/application.yml"
        fi
        
        info "备份完成: $BACKUP_DIR"
    else
        info "未发现旧版本，跳过备份"
    fi
}

# ============================================================================
# 编译打包后端
# ============================================================================
build_backend() {
    info "开始编译后端..."
    
    cd "$SOURCE_DIR"
    
    # 使用 Maven Wrapper 编译
    if [ -f "./mvnw" ]; then
        ./mvnw clean package -DskipTests=true
    elif [ -f "./mvnw.cmd" ]; then
        ./mvnw.cmd clean package -DskipTests=true
    else
        error "Maven Wrapper 不存在，请确保项目完整"
    fi
    
    # 检查打包结果
    JAR_FILE=$(find "$SOURCE_DIR/data-agent-management/target" -name "spring-ai-audaque-data-agent-management-*.jar" ! -name "*.original" | head -n1)
    
    if [ ! -f "$JAR_FILE" ]; then
        error "后端编译失败，未找到 JAR 文件"
    fi
    
    JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
    info "后端编译成功: $JAR_FILE ($JAR_SIZE)"
}

# ============================================================================
# 编译打包前端
# ============================================================================
build_frontend() {
    info "开始编译前端..."
    
    cd "$SOURCE_DIR/data-agent-frontend"
    
    # 安装依赖
    if [ ! -d "node_modules" ]; then
        info "安装前端依赖..."
        yarn install
    fi
    
    # 构建生产版本
    info "构建前端生产版本..."
    yarn build
    
    # 检查构建结果
    if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
        error "前端编译失败，未找到 dist 目录或 index.html"
    fi
    
    DIST_SIZE=$(du -sh dist | cut -f1)
    info "前端编译成功: dist/ ($DIST_SIZE)"
}

# ============================================================================
# 部署后端
# ============================================================================
deploy_backend() {
    info "部署后端..."
    
    # 创建部署目录
    sudo mkdir -p "$DEPLOY_DIR"
    sudo chown -R $USER:$USER "$DEPLOY_DIR"
    
    # 复制 JAR 包
    JAR_FILE=$(find "$SOURCE_DIR/data-agent-management/target" -name "spring-ai-audaque-data-agent-management-*.jar" ! -name "*.original" | head -n1)
    cp "$JAR_FILE" "$DEPLOY_DIR/dataagent-backend.jar"
    info "后端 JAR 已部署到: $DEPLOY_DIR/dataagent-backend.jar"
    
    # 创建或更新配置文件
    if [ ! -f "$DEPLOY_DIR/application.yml" ]; then
        if [ -f "$SOURCE_DIR/application.yml.sample" ]; then
            cp "$SOURCE_DIR/application.yml.sample" "$DEPLOY_DIR/application.yml"
            info "配置文件已创建，请检查并修改数据库连接信息:"
            info "  vi $DEPLOY_DIR/application.yml"
            
            # 自动替换数据库配置（如果变量已设置）
            sed -i "s|url: jdbc:mysql://127.0.0.1:3306/data_agent|url: jdbc:mysql://$DB_HOST:$DB_PORT/$DB_NAME|g" "$DEPLOY_DIR/application.yml"
            sed -i "s|username: cyl|username: $DB_USER|g" "$DEPLOY_DIR/application.yml"
            sed -i "s|password: Audaque@123|password: $DB_PASSWORD|g" "$DEPLOY_DIR/application.yml"
            info "已自动更新配置文件中的数据库连接信息"
        fi
    else
        info "使用现有配置文件: $DEPLOY_DIR/application.yml"
    fi
}

# ============================================================================
# 部署前端
# ============================================================================
deploy_frontend() {
    info "部署前端..."
    
    # 创建前端目录
    sudo mkdir -p /var/www/dataagent
    
    # 复制前端文件
    sudo rm -rf /var/www/dataagent/*
    sudo cp -r "$SOURCE_DIR/data-agent-frontend/dist/"* /var/www/dataagent/
    info "前端文件已部署到: /var/www/dataagent/"
    
    # 配置 Nginx
    configure_nginx
}

# ============================================================================
# 配置 Nginx
# ============================================================================
configure_nginx() {
    info "配置 Nginx..."
    
    # 获取本机 IP
    HOST_IP=$(hostname -I | awk '{print $1}')
    if [ -z "$HOST_IP" ]; then
        HOST_IP=$(ip route get 1 | awk '{print $7}' | head -n1)
    fi
    if [ -z "$HOST_IP" ]; then
        HOST_IP="localhost"
    fi
    
    # 创建 Nginx 配置文件
    sudo tee /etc/nginx/sites-available/dataagent > /dev/null <<EOF
server {
    listen $FRONTEND_PORT;
    server_name $HOST_IP localhost;

    # 前端静态文件
    location / {
        root /var/www/dataagent;
        index index.html;
        try_files \$uri \$uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:$BACKEND_PORT/api/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Actuator 端点代理
    location /actuator/ {
        proxy_pass http://localhost:$BACKEND_PORT/actuator/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }

    # 文件上传大小限制
    client_max_body_size 10M;
}
EOF
    
    # 启用配置
    if [ -d "/etc/nginx/sites-enabled" ]; then
        sudo ln -sf /etc/nginx/sites-available/dataagent /etc/nginx/sites-enabled/
        sudo rm -f /etc/nginx/sites-enabled/default
    else
        # CentOS/RHEL 风格配置
        sudo ln -sf /etc/nginx/sites-available/dataagent /etc/nginx/conf.d/dataagent.conf
    fi
    
    # 测试配置
    if sudo nginx -t; then
        info "Nginx 配置测试通过"
        sudo systemctl reload nginx
        info "Nginx 已重新加载配置"
    else
        error "Nginx 配置测试失败，请检查配置文件"
    fi
}

# ============================================================================
# 启动后端服务
# ============================================================================
start_backend() {
    info "启动后端服务..."
    
    cd "$DEPLOY_DIR"
    
    # 后台启动（支持 IPv4 和 IPv6 双栈）
    # 注意：不添加 -Djava.net.preferIPv4Stack=true，让 JVM 同时监听 IPv4 和 IPv6
    nohup java -Xmx2g -Xms2g \
        -XX:+UseG1GC \
        -Dfile.encoding=UTF-8 \
        -jar dataagent-backend.jar \
        > console.log 2>&1 &
    
    BACKEND_PID=$!
    echo $BACKEND_PID > "$DEPLOY_DIR/backend.pid"
    info "后端服务已启动 (PID: $BACKEND_PID)"
    
    # 等待服务启动
    info "等待后端服务启动..."
    for i in {1..60}; do
        if curl -s http://localhost:$BACKEND_PORT/actuator/health > /dev/null 2>&1 || \
           curl -s http://localhost:$BACKEND_PORT/api/agent/list > /dev/null 2>&1; then
            info "后端服务启动成功！"
            
            # 验证监听地址
            echo ""
            info "监听地址信息："
            netstat -anl | grep ":$BACKEND_PORT " | grep LISTEN | while read line; do
                if echo "$line" | grep -q "0.0.0.0:$BACKEND_PORT"; then
                    info "  ✅ IPv4: 0.0.0.0:$BACKEND_PORT"
                elif echo "$line" | grep -q ":::$BACKEND_PORT"; then
                    info "  ✅ IPv6: :::$BACKEND_PORT"
                fi
            done
            
            return 0
        fi
        echo -n "."
        sleep 1
    done
    
    echo ""
    error "后端服务启动超时，请查看日志: tail -f $DEPLOY_DIR/logs/application.log"
}

# ============================================================================
# 验证服务
# ============================================================================
verify_services() {
    info "验证服务状态..."
    
    # 获取本机 IP
    HOST_IP=$(hostname -I | awk '{print $1}')
    if [ -z "$HOST_IP" ]; then
        HOST_IP=$(ip route get 1 | awk '{print $7}' | head -n1)
    fi
    if [ -z "$HOST_IP" ]; then
        HOST_IP="localhost"
    fi
    
    echo ""
    info "=========================================="
    info "  服务验证"
    info "=========================================="
    
    # 验证后端
    if curl -s http://localhost:$BACKEND_PORT/api/agent/list > /dev/null 2>&1; then
        info "✅ 后端服务正常: http://$HOST_IP:$BACKEND_PORT"
    else
        warn "❌ 后端服务异常"
    fi
    
    # 验证 Actuator
    if curl -s http://localhost:$BACKEND_PORT/actuator/health > /dev/null 2>&1; then
        HEALTH=$(curl -s http://localhost:$BACKEND_PORT/actuator/health | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
        info "✅ 健康检查: $HEALTH"
    fi
    
    # 验证前端
    if curl -s http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
        info "✅ 前端服务正常: http://$HOST_IP:$FRONTEND_PORT"
    else
        warn "❌ 前端服务异常"
    fi
    
    echo ""
    info "=========================================="
    info "  部署完成！"
    info "=========================================="
    info "访问地址:"
    info "  前端: http://$HOST_IP:$FRONTEND_PORT"
    info "  后端: http://$HOST_IP:$BACKEND_PORT"
    info "  健康检查: http://$HOST_IP:$BACKEND_PORT/actuator/health"
    info ""
    info "管理命令:"
    info "  查看后端日志: tail -f $DEPLOY_DIR/logs/application.log"
    info "  查看前端日志: sudo tail -f /var/log/nginx/access.log"
    info "  停止后端: kill \$(cat $DEPLOY_DIR/backend.pid)"
    info "  重启 Nginx: sudo systemctl restart nginx"
    info "=========================================="
}

# ============================================================================
# 主流程
# ============================================================================
main() {
    echo ""
    info "=========================================="
    info "  DataAgent 一键部署脚本"
    info "=========================================="
    echo ""
    
    # 检测操作系统
    detect_os
    
    # 检查并安装依赖
    check_install_java
    check_install_nodejs
    check_install_nginx
    check_mysql
    
    echo ""
    info "=========================================="
    info "  开始部署"
    info "=========================================="
    echo ""
    
    # 停止服务
    stop_services
    
    # 备份旧版本
    backup_old_version
    
    # 编译打包
    build_backend
    build_frontend
    
    # 部署
    deploy_backend
    deploy_frontend
    
    # 启动服务
    start_backend
    
    # 验证
    verify_services
}

# 执行主流程
main "$@"
