# ============================================================================
# DataAgent 生产环境配置文件示例
# ============================================================================
# 使用说明：
# 1. 复制此文件为 application.yml（在 JAR 包同级目录或 config/ 子目录）
# 2. 根据实际环境修改配置项（特别是数据库连接信息）
# 3. 使用 java -jar 启动时会自动加载外部配置文件
#
# 注意：此文件中的配置会覆盖 JAR 包内部的默认配置
# ============================================================================

# ============================================================================
# 服务器配置
# ============================================================================
server:
  port: 8065                  # 后端服务端口
  address: 0.0.0.0            # 监听地址（0.0.0.0 表示允许外部访问）

# ============================================================================
# 数据库配置（必须配置）
# ============================================================================
# 重要说明：此数据库用于存储 DataAgent 的元数据（Agent 配置、会话记录、知识库等）
#          不是用户要分析的业务数据库（业务数据库在前端界面配置）
# ============================================================================
spring:
  datasource:
    # 数据库连接地址（请根据实际环境修改）
    url: jdbc:mysql://127.0.0.1:3306/data_agent?useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&transformedBitIsBoolean=true&allowMultiQueries=true&allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Shanghai
    
    # 数据库用户名（请修改为实际用户名）
    username: cyl
    
    # 数据库密码（请修改为实际密码，建议生产环境使用环境变量）
    password: Audaque@123
    
    # 数据库驱动（无需修改）
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.alibaba.druid.pool.DruidDataSource
  
  # 数据库初始化配置（生产环境建议禁用）
  sql:
    init:
      mode: never                           # never: 不执行初始化脚本（生产环境推荐）
                                            # always: 始终执行（开发环境）
                                            # embedded: 仅嵌入式数据库执行（如 H2）
      schema-locations: classpath:sql/schema.sql  # 建表脚本
      data-locations: classpath:sql/data.sql      # 初始数据脚本
      continue-on-error: true               # 脚本执行出错时继续
      separator: ;
      encoding: utf-8
  
  # 重要说明：
  # 生产环境首次部署时，请手动执行数据库初始化脚本：
  #   mysql -u username -p database_name < data-agent-management/src/main/resources/sql/schema.sql
  # 后续启动必须设置 mode: never，避免重复初始化导致数据丢失！
  
  # ============================================================================
  # AI 配置
  # ============================================================================
  ai:
    # 重试配置
    retry:
      max-attempts: 5                       # 最大重试次数
      initial-interval: 2000ms              # 初始重试间隔
      multiplier: 2.0                       # 重试间隔倍数
    
    # 向量存储配置
    vectorstore:
      type: simple                          # 向量存储类型：simple（内存）或 elasticsearch
      # 如果使用 Elasticsearch，需要配置以下参数：
      # elasticsearch:
      #   uris: http://localhost:9200
      #   username: elastic
      #   password: changeme
    
    # DataAgent 专属配置
    alibaba:
      data-agent:
        # 向量检索配置
        vector-store:
          table-topk-limit: 10              # 表检索返回的最大数量
          table-similarity-threshold: 0.2   # 表检索的相似度阈值
          default-topk-limit: 8             # 默认检索返回数量
          default-similarity-threshold: 0.4 # 默认相似度阈值
        
        # LLM 服务类型
        llm-service-type: stream            # stream（流式）或 block（阻塞）
        
        # Python 代码执行器配置
        code-executor:
          # 运行环境：local（本地）或 docker（Docker容器）
          # 生产环境建议使用 docker，更安全隔离
          code-pool-executor: local
          # Python 执行的最大重试次数
          python-max-tries-count: 5
        
        # 文件存储配置
        file:
          type: local                       # 存储类型：local（本地）或 oss（阿里云OSS）
          path-prefix: data-agent           # 路径前缀
          path: uploads                     # 本地存储路径
          url-prefix: /uploads              # URL 前缀
          imageSize: 2097152                # 图片大小限制（2MB）
          
          # 阿里云 OSS 配置（type 为 oss 时需要配置）
          oss:
            access-key-id: ${OSS_ACCESS_KEY_ID:}        # OSS Access Key ID
            access-key-secret: ${OSS_ACCESS_KEY_SECRET:} # OSS Access Key Secret
            endpoint: ${OSS_ENDPOINT:}                   # OSS Endpoint（如：oss-cn-hangzhou.aliyuncs.com）
            bucket-name: ${OSS_BUCKET_NAME:}             # OSS Bucket 名称
            custom-domain: ${OSS_CUSTOM_DOMAIN:}         # 自定义域名（可选）
        
        # SQL 执行重试次数
        max-sql-retry-count: 10
  
  # ============================================================================
  # 文件上传配置
  # ============================================================================
  servlet:
    multipart:
      max-file-size: 10MB                   # 单个文件最大大小
      max-request-size: 10MB                # 请求最大大小
      enabled: true

# ============================================================================
# MyBatis 配置
# ============================================================================
mybatis:
  configuration:
    map-underscore-to-camel-case: true      # 下划线转驼峰
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl  # 日志实现

# ============================================================================
# Actuator 监控配置
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics          # 暴露的端点：health(健康检查)、info(应用信息)、metrics(性能指标)
      base-path: /actuator                    # 端点基础路径
  endpoint:
    health:
      show-details: always                    # 总是显示详细健康信息（包括数据库、磁盘空间等）
  
  # 生产环境建议暴露更多端点（可选）：
  # include: health,info,metrics,env,loggers,threaddump,heapdump

# ============================================================================
# 日志配置
# ============================================================================
logging:
  # 日志级别配置
  level:
    root: info                                            # 根日志级别
    com.audaque.cloud.ai.dataagent.service: info          # 业务服务日志
    com.audaque.cloud.ai.dataagent.workflow.node: info    # 工作流节点日志
    com.alibaba.cloud.ai.mapper: info                     # MyBatis Mapper 日志
    org.springframework.jdbc: warn                        # JDBC 日志
  
  # 日志文件配置（推荐生产环境启用）
  file:
    name: logs/application.log              # 日志文件路径（相对于 JAR 包所在目录）
    max-size: 100MB                         # 单个日志文件最大大小
    max-history: 30                         # 保留天数
  
  # 其他日志文件路径配置示例：
  # - 绝对路径：/var/log/dataagent/application.log
  # - 相对路径：logs/application.log（推荐，会在 JAR 同级创建 logs 目录）
  # - 用户目录：~/logs/dataagent/application.log
  
  # 日志格式配置
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    # file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ============================================================================
# 其他配置建议
# ============================================================================
# 
# 1. 敏感信息建议使用环境变量：
#    - 数据库密码：DATA_AGENT_DATASOURCE_PASSWORD
#    - OSS 密钥：OSS_ACCESS_KEY_SECRET
#    - 启动命令：export DATA_AGENT_DATASOURCE_PASSWORD=your_password && java -jar xxx.jar
# 
# 2. 生产环境建议配置：
#    - 启用日志文件输出
#    - 使用 Docker 执行 Python 代码
#    - 使用 OSS 存储文件（如果文件量大）
#    - 配置 Elasticsearch 作为向量数据库（如果需要 RAG）
# 
# 3. 性能优化建议：
#    - 调整数据库连接池大小（Druid 配置）
#    - 配置适当的 JVM 参数（如 -Xmx2g -Xms2g）
#    - 启用 GC 日志监控
# ============================================================================
