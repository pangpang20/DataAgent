# ============================================================================
# DataAgent 生产环境配置文件示例
# ============================================================================
# 使用说明：
# 1. 复制此文件为 application.yml（在 JAR 包同级目录或 config/ 子目录）
# 2. 根据实际环境修改配置项（特别是数据库连接信息）
# 3. 使用 java -jar 启动时会自动加载外部配置文件
#
# 注意：此文件中的配置会覆盖 JAR 包内部的默认配置
# ============================================================================

# ============================================================================
# 服务器配置
# ============================================================================
server:
  port: 8065                  # 后端服务端口
  address: 0.0.0.0            # 监听地址（0.0.0.0 表示允许外部访问）
  
  # 双栈支持说明：
  # - address: 0.0.0.0 会绑定所有 IPv4 接口
  # - Spring Boot 会自动检测系统能力，如果支持 IPv6 会额外监听 IPv6
  # - 实际监听结果（netstat -anl | grep 8065）：
  #   方式1 - Ubuntu/Debian:
  #     tcp   0  0  0.0.0.0:8065  0.0.0.0:*  LISTEN  (IPv4)
  #     tcp6  0  0  :::8065       :::*       LISTEN  (IPv6)
  #   方式2 - CentOS/RHEL/KylinV10:
  #     tcp6  0  0  :::8065       :::*       LISTEN  (IPv6 双栈模式，同时接受 IPv4 连接）
  # - 这两种情况都支持 IPv4 和 IPv6 客户端访问！

# ============================================================================
# 数据库配置（必须配置）
# ============================================================================
# 重要说明：此数据库用于存储 DataAgent 的元数据（Agent 配置、会话记录、知识库等）
#          不是用户要分析的业务数据库（业务数据库在前端界面配置）
# 
# 支持的数据库类型：MySQL（默认）、达梦数据库（DM8）
# ============================================================================
spring:
  main:
    allow-bean-definition-overriding: true
  autoconfigure:
    exclude: ${VECTOR_STORE_EXCLUDE:org.springframework.ai.vectorstore.milvus.autoconfigure.MilvusVectorStoreAutoConfiguration,org.springframework.ai.vectorstore.elasticsearch.autoconfigure.ElasticsearchVectorStoreAutoConfiguration}
  datasource:
    # ========================================================================
    # 数据库平台类型（可选：mysql | dameng）
    # ========================================================================
    platform: mysql                         # 默认使用 MySQL
                                            # 如需使用达梦数据库，改为：dameng
    
    # ========================================================================
    # 数据库连接地址（请根据实际环境修改）
    # ========================================================================
    # MySQL 示例：
    url: jdbc:mysql://127.0.0.1:3306/data_agent?useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&transformedBitIsBoolean=true&allowMultiQueries=true&allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Shanghai
    
    # 达梦数据库示例（如使用达梦，请取消注释并注释掉上面的 MySQL URL）：
    # url: jdbc:dm://127.0.0.1:5236?zeroDateTimeBehavior=convertToNull&useUnicode=true&characterEncoding=UTF-8
    
    # 数据库用户名（请修改为实际用户名）
    username: cyl
    # 达梦数据库默认用户名：SYSDBA
    
    # 数据库密码（请修改为实际密码，建议生产环境使用环境变量）
    password: Audaque@123
    # 达梦数据库默认密码：SYSDBA
    
    # ========================================================================
    # 数据库驱动配置
    # ========================================================================
    # MySQL 驱动（默认）：
    driver-class-name: com.mysql.cj.jdbc.Driver
    # 达梦数据库驱动（如使用达梦，请取消注释并注释掉上面的 MySQL 驱动）：
    # driver-class-name: dm.jdbc.driver.DmDriver
    
    type: com.alibaba.druid.pool.DruidDataSource
    
    # ========================================================================
    # Druid 连接池配置
    # ========================================================================
    druid:
      # 连接池基础配置
      initial-size: 5                       # 初始连接数
      min-idle: 5                           # 最小空闲连接数
      max-active: 20                        # 最大活跃连接数
      max-wait: 60000                       # 获取连接最大等待时间（毫秒）
      
      # 验证查询配置
      # MySQL 使用：SELECT 1
      validation-query: SELECT 1
      # 达梦数据库使用（如使用达梦，请取消注释并注释掉上面的 MySQL 验证查询）：
      # validation-query: SELECT 1 FROM DUAL
      
      test-while-idle: true                 # 空闲时检测连接有效性
      test-on-borrow: false                 # 获取连接时不检测
      test-on-return: false                 # 归还连接时不检测
      
      # 事务隔离级别（2=READ_COMMITTED）
      # MySQL 默认：4（REPEATABLE_READ），达梦推荐：2（READ_COMMITTED）
      default-transaction-isolation: 2
  
  # 数据库初始化配置（生产环境建议禁用）
  sql:
    init:
      mode: never                           # never: 不执行初始化脚本（生产环境推荐）
                                            # always: 始终执行（开发环境）
                                            # embedded: 仅嵌入式数据库执行（如 H2）
      # 根据数据库平台自动选择 SQL 脚本
      schema-locations: classpath:sql/${spring.datasource.platform}/schema.sql
      data-locations: classpath:sql/${spring.datasource.platform}/data.sql
      continue-on-error: true               # 脚本执行出错时继续
      separator: ;
      encoding: utf-8
  
  # 重要说明：
  # 生产环境首次部署时，请手动执行数据库初始化脚本：
  #   MySQL:
  #     mysql -u username -p database_name < data-agent-management/src/main/resources/sql/mysql/schema.sql
  #   达梦数据库：
  #     disql SYSDBA/SYSDBA@localhost:5236 < data-agent-management/src/main/resources/sql/dameng/schema.sql
  # 后续启动必须设置 mode: never，避免重复初始化导致数据丢失！
  
  # ============================================================================
  # AI 配置
  # ============================================================================
  ai:
    # 重试配置
    retry:
      max-attempts: 10                       # 最大重试次数
      initial-interval: 2000ms              # 初始重试间隔
      multiplier: 2.0                       # 重试间隔倍数
    
    # 向量存储配置
    vectorstore:
      milvus:
        enabled: false
        initialize-schema: true           # 自动创建 Milvus 集合（首次启动时必须为 true）
        embedding-dimension: 1024          # Spring AI 标准配置，Milvus 集合创建时使用的嵌入维度
        default-embedding-dimension: 1024  # 默认嵌入维度（未配置 Embedding 模型时生效）
        client:
          host: localhost
          port: 19530
          username: root
          password: Milvus
          database-name: default
        collection-name: data_agent_vector
        flush-delay-ms: 2000  # Milvus flush 操作延迟（毫秒），避免速率限制
        flush-retry-count: 3  # flush 操作重试次数
        flush-initial-backoff-ms: 1000  # flush 操作初始退避时间（毫秒）
      elasticsearch:
        enabled: false
      # 如果使用 Milvus，需要配置以下参数：
      # milvus:
      #   enabled: true
      #   initialize-schema: true         # 首次启动时必须为 true，自动创建集合
      #   default-embedding-dimension: 1024  # 默认嵌入维度（建议与实际 Embedding 模型维度一致）
      #   client:
      #     host: localhost
      #     port: 19530
      #     username: root
      #     password: Milvus
      #     database-name: default
      #   collection-name: data_agent_vector
      # 如果使用 Elasticsearch，需要配置以下参数：
      # elasticsearch:
      #   uris: http://localhost:9200
      #   username: elastic
      #   password: changeme
    
    # DataAgent 专属配置
    alibaba:
      data-agent:
        # 向量库类型：simple（内存）, milvus, elasticsearch
        vector-store:
          type: simple                      # 默认使用内存向量库
          table-topk-limit: 10              # 表检索返回的最大数量
          table-similarity-threshold: 0.2   # 表检索的相似度阈值
          default-topk-limit: 8             # 默认检索返回数量
          default-similarity-threshold: 0.4 # 默认相似度阈值
        
        # LLM 服务类型
        llm-service-type: stream            # stream（流式）或 block（阻塞）
        
        # Python 代码执行器配置
        code-executor:
          # 运行环境：local（本地环境执行）或 docker（Docker 容器内启动子容器执行）
          # 注意：在 Docker 部署模式下，建议使用 local 模式（利用镜像自带的 Python），以避免 Docker-in-Docker 的复杂权限配置
          code-pool-executor: local
          # Python 执行的最大重试次数
          python-max-tries-count: 5
        
        # 文件存储配置
        file:
          type: local                       # 存储类型：local（本地）或 oss（阿里云OSS）
          path-prefix: data-agent           # 路径前缀
          path: uploads                     # 本地存储路径
          url-prefix: /uploads              # URL 前缀
          imageSize: 2097152                # 图片大小限制（2MB）
          
          # 阿里云 OSS 配置（type 为 oss 时需要配置）
          oss:
            access-key-id: ${OSS_ACCESS_KEY_ID:}        # OSS Access Key ID
            access-key-secret: ${OSS_ACCESS_KEY_SECRET:} # OSS Access Key Secret
            endpoint: ${OSS_ENDPOINT:}                   # OSS Endpoint（如：oss-cn-hangzhou.aliyuncs.com）
            bucket-name: ${OSS_BUCKET_NAME:}             # OSS Bucket 名称
            custom-domain: ${OSS_CUSTOM_DOMAIN:}         # 自定义域名（可选）
        
        # SQL 执行重试次数
        max-sql-retry-count: 10
  
  # ============================================================================
  # 文件上传配置
  # ============================================================================
  servlet:
    multipart:
      max-file-size: 10MB                   # 单个文件最大大小
      max-request-size: 10MB                # 请求最大大小
      enabled: true

# ============================================================================
# MyBatis 配置
# ============================================================================
mybatis:
  configuration:
    map-underscore-to-camel-case: true      # 下划线转驼峰
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl  # 日志实现

# ============================================================================
# Actuator 监控配置
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics          # 暴露的端点：health(健康检查)、info(应用信息)、metrics(性能指标)
      base-path: /actuator                    # 端点基础路径
  endpoint:
    health:
      show-details: always                    # 总是显示详细健康信息（包括数据库、磁盘空间等）
  
  # 健康检查配置
  health:
    elasticsearch:
      enabled: false                          # 禁用 Elasticsearch 健康检查（如果未安装 ES）
    milvus:
      enabled: false                          # 禁用 Milvus 健康检查（如果未安装 Milvus）
    defaults:
      enabled: true                           # 启用默认健康检查（数据库、磁盘等）
  
  # 生产环境建议暴露更多端点（可选）：
  # include: health,info,metrics,env,loggers,threaddump,heapdump

# ============================================================================
# 日志配置
# ============================================================================
logging:
  # 日志级别配置
  level:
    root: INFO                                            # 根日志级别
    com.audaque.cloud.ai.dataagent.service: DEBUG         # 业务服务日志
    com.audaque.cloud.ai.dataagent.workflow.node: DEBUG   # 工作流节点日志
    com.alibaba.cloud.ai.mapper: DEBUG                    # MyBatis Mapper 日志
    org.springframework.jdbc: DEBUG                       # JDBC 日志（查看所有 SQL）
    org.apache.coyote.http11.Http11Processor: INFO       # 屏蔽 Tomcat EOFException 日志
    org.apache.tomcat: WARN                              # Tomcat 其他组件
    org.elasticsearch.client: WARN                        # Elasticsearch 客户端
    # 屏蔽 favicon.ico 请求的 NoResourceFoundException 错误
    org.springframework.web.servlet.resource.ResourceHttpRequestHandler: ERROR
    # 打印 Agent 相关的 SQL 语句（包括插入、更新操作）
    com.audaque.cloud.ai.dataagent.mapper.AgentMapper: DEBUG
    
    # 生产环境建议：
    # - root: WARN 或 INFO
    # - com.audaque.cloud.ai.dataagent.service: INFO
    # - org.springframework.jdbc: WARN（关闭 SQL 日志以提升性能）
  
  # 日志文件配置（推荐生产环境启用）
  file:
    name: logs/application.log              # 日志文件路径（相对于 JAR 包所在目录）
    max-size: 100MB                         # 单个日志文件最大大小
    max-history: 30                         # 保留天数
  
  # 其他日志文件路径配置示例：
  # - 绝对路径：/var/log/dataagent/application.log
  # - 相对路径：logs/application.log（推荐，会在 JAR 同级创建 logs 目录）
  # - 用户目录：~/logs/dataagent/application.log
  
  # 日志格式配置
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    # file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ============================================================================
# 其他配置建议
# ============================================================================
# 
# 1. 敏感信息建议使用环境变量：
#    - 数据库密码：DATA_AGENT_DATASOURCE_PASSWORD
#    - OSS 密钥：OSS_ACCESS_KEY_SECRET
#    - 启动命令：export DATA_AGENT_DATASOURCE_PASSWORD=your_password && java -jar xxx.jar
# 
# 2. 生产环境建议配置：
#    - 启用日志文件输出
#    - 使用 Docker 执行 Python 代码
#    - 使用 OSS 存储文件（如果文件量大）
#    - 配置 Elasticsearch 作为向量数据库（如果需要 RAG）
# 
# 3. 性能优化建议：
#    - 调整数据库连接池大小（Druid 配置）
#    - 配置适当的 JVM 参数（如 -Xmx2g -Xms2g）
#    - 启用 GC 日志监控
# ============================================================================
